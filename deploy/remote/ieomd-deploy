#!/usr/bin/env bash
set -euo pipefail

usage() {
  echo "Usage: ieomd-deploy deploy --dir /opt/ieomd --backend-image <ref> --web-image <ref> [--backup-dir /var/backups/ieomd]" >&2
}

if [[ "${1:-}" != "deploy" ]]; then
  usage
  exit 2
fi
shift

deploy_dir="/opt/ieomd"
backup_dir="/var/backups/ieomd"
backend_image=""
web_image=""
state_file=""
previous_backend_image=""
previous_web_image=""
backup_path=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --dir)
      deploy_dir="$2"
      shift 2
      ;;
    --backup-dir)
      backup_dir="$2"
      shift 2
      ;;
    --backend-image)
      backend_image="$2"
      shift 2
      ;;
    --web-image)
      web_image="$2"
      shift 2
      ;;
    *)
      echo "Unknown arg: $1" >&2
      usage
      exit 2
      ;;
  esac
done

if [[ -z "$backend_image" || -z "$web_image" ]]; then
  echo "Missing required --backend-image / --web-image" >&2
  usage
  exit 2
fi

state_file="$deploy_dir/.ieomd-images.env"

if [[ -f "$state_file" ]]; then
  # shellcheck source=/dev/null
  source "$state_file"
  previous_backend_image="${BACKEND_IMAGE:-}"
  previous_web_image="${WEB_IMAGE:-}"
fi

if [[ -f "$deploy_dir/.env" ]]; then
  set -a
  # shellcheck source=/dev/null
  source "$deploy_dir/.env"
  set +a
fi

rollback() {
  trap - ERR
  set +e
  code="$?"
  echo "[ieomd] deploy failed (exit $code)" >&2

  if [[ -n "$backup_path" && -f "$backup_path" ]]; then
    echo "[ieomd] restoring DB from backup $backup_path" >&2
    mkdir -p "$(dirname "$db_path")"
    cp -a "$backup_path" "$db_path"
  fi

  if [[ -n "$previous_backend_image" && -n "$previous_web_image" ]]; then
    echo "[ieomd] attempting rollback to previous images" >&2
    BACKEND_IMAGE="$previous_backend_image" WEB_IMAGE="$previous_web_image" docker compose up -d --remove-orphans
  else
    echo "[ieomd] no previous image state file found; manual rollback may be required" >&2
  fi

  exit "$code"
}

trap rollback ERR

timestamp="$(date -u +%Y%m%dT%H%M%SZ)"
mkdir -p "$backup_dir"

cd "$deploy_dir"

echo "[ieomd] pulling images..."
BACKEND_IMAGE="$backend_image" WEB_IMAGE="$web_image" docker compose pull

data_dir="${DATA_DIR:-/var/lib/ieomd}"

if [[ -n "${DB_PATH:-}" ]]; then
  db_path="$DB_PATH"
elif [[ "${DATABASE_URL:-}" =~ ^sqlite:////data/(.+)$ ]]; then
  db_path="$data_dir/${BASH_REMATCH[1]}"
else
  db_path="$data_dir/secrets.db"
fi

echo "[ieomd] stopping backend (maintenance window)..."
docker compose stop backend || true

if [[ -f "$db_path" ]]; then
  db_name="$(basename "$db_path")"
  backup_path="$backup_dir/$db_name.$timestamp"
  echo "[ieomd] backing up DB to $backup_path"
  cp -a "$db_path" "$backup_path"
else
  echo "[ieomd] no existing DB at $db_path (first deploy?)"
fi

echo "[ieomd] running migrations..."
BACKEND_IMAGE="$backend_image" WEB_IMAGE="$web_image" docker compose run --rm backend alembic upgrade head

echo "[ieomd] starting services..."
BACKEND_IMAGE="$backend_image" WEB_IMAGE="$web_image" docker compose up -d --remove-orphans

cat > "$state_file" <<EOF
BACKEND_IMAGE=$backend_image
WEB_IMAGE=$web_image
EOF

echo "[ieomd] done"
