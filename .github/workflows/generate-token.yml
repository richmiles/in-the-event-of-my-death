name: Generate Capability Token

on:
  workflow_dispatch:
    inputs:
      tier:
        description: "Token tier"
        required: true
        type: choice
        options:
          - basic
          - standard
          - large
      recipient_email:
        description: "Recipient email (for tracking)"
        required: true
      reason:
        description: "Reason for token (e.g., beta tester, promo)"
        required: true
      campaign:
        description: "Campaign name (optional)"
        required: false

permissions:
  contents: read

jobs:
  generate:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Generate Token
        id: generate
        run: |
          # Build metadata JSON
          METADATA=$(jq -n \
            --arg email "${{ inputs.recipient_email }}" \
            --arg reason "${{ inputs.reason }}" \
            --arg campaign "${{ inputs.campaign }}" \
            --arg actor "${{ github.actor }}" \
            --arg run_id "${{ github.run_id }}" \
            '{
              recipient_email: $email,
              reason: $reason,
              campaign: (if $campaign == "" then null else $campaign end),
              generated_by: $actor,
              workflow_run: $run_id
            }')

          # Build request body
          REQUEST_BODY=$(jq -n \
            --arg tier "${{ inputs.tier }}" \
            --arg run_id "${{ github.run_id }}" \
            --argjson metadata "$METADATA" \
            '{
              tier: $tier,
              payment_provider: "github-actions",
              payment_reference: $run_id,
              token_metadata: $metadata
            }')

          # Make API request
          RESPONSE=$(curl -sS -w "\n%{http_code}" -X POST "https://${{ secrets.PROD_SITE_HOST }}/api/v1/capability-tokens" \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${{ secrets.INTERNAL_API_KEY }}" \
            -d "$REQUEST_BODY")

          # Extract status code (last line) and body (everything else)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" != "201" ]; then
            echo "## ❌ Token Generation Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "HTTP Status: $HTTP_CODE" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$BODY" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Extract token from response
          TOKEN=$(echo "$BODY" | jq -r '.token')

          echo "## ✅ Capability Token Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Tier** | ${{ inputs.tier }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Recipient** | ${{ inputs.recipient_email }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Reason** | ${{ inputs.reason }} |" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ inputs.campaign }}" ]; then
            echo "| **Campaign** | ${{ inputs.campaign }} |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Token (copy this - shown only once)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "$TOKEN" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "_Generated by @${{ github.actor }} on $(date -u '+%Y-%m-%d %H:%M:%S UTC')_" >> $GITHUB_STEP_SUMMARY
