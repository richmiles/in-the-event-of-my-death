name: Promote to Production

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        type: choice
        default: 'minor'
        options:
          - minor   # 0.1.0 -> 0.2.0 (project completion)
          - patch   # 0.1.0 -> 0.1.1 (hotfix)

permissions:
  contents: write
  packages: write

jobs:
  bump_version:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.bump.outputs.new_version }}
      commit_sha: ${{ steps.push.outputs.commit_sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'current'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump version
        id: bump
        working-directory: frontend
        run: |
          new_version=$(npm version ${{ inputs.version_bump }} --no-git-tag-version)
          new_version="${new_version#v}"
          echo "new_version=$new_version" >> "$GITHUB_OUTPUT"
          echo "Bumped to version: $new_version"

      - name: Commit, tag, and push
        id: push
        run: |
          version="${{ steps.bump.outputs.new_version }}"

          git add frontend/package.json
          git commit -m "chore: bump version to v${version}"
          git tag "v${version}"
          git push origin main --tags

          commit_sha=$(git rev-parse HEAD)
          echo "commit_sha=$commit_sha" >> "$GITHUB_OUTPUT"

          echo "## Version Bump" >> "$GITHUB_STEP_SUMMARY"
          echo "- **New version:** v${version}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Bump type:** ${{ inputs.version_bump }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Commit:** \`${commit_sha}\`" >> "$GITHUB_STEP_SUMMARY"

  build_images:
    runs-on: ubuntu-latest
    needs: bump_version
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.bump_version.outputs.commit_sha }}

      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute tags
        id: tags
        run: |
          version="${{ needs.bump_version.outputs.new_version }}"
          echo "tag=v${version}" >> "$GITHUB_OUTPUT"
          echo "backend=ghcr.io/${GITHUB_REPOSITORY_OWNER}/in-the-event-of-my-death-backend" >> "$GITHUB_OUTPUT"
          echo "web=ghcr.io/${GITHUB_REPOSITORY_OWNER}/in-the-event-of-my-death-web" >> "$GITHUB_OUTPUT"

      - name: Build and push backend
        uses: docker/build-push-action@v6
        with:
          context: .
          file: backend/Dockerfile
          push: true
          tags: |
            ${{ steps.tags.outputs.backend }}:${{ steps.tags.outputs.tag }}

      - name: Build and push web
        uses: docker/build-push-action@v6
        with:
          context: .
          file: frontend/Dockerfile
          push: true
          tags: |
            ${{ steps.tags.outputs.web }}:${{ steps.tags.outputs.tag }}

      - name: Summary
        run: |
          version="${{ needs.bump_version.outputs.new_version }}"
          echo "## Docker Images Built" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Backend:** \`ghcr.io/${GITHUB_REPOSITORY_OWNER}/in-the-event-of-my-death-backend:v${version}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Web:** \`ghcr.io/${GITHUB_REPOSITORY_OWNER}/in-the-event-of-my-death-web:v${version}\`" >> "$GITHUB_STEP_SUMMARY"

  deploy_production:
    runs-on: ubuntu-latest
    needs: [bump_version, build_images]
    environment: production
    steps:
      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PROD_SSH_KEY }}

      - name: Configure known_hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.PROD_SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy
        run: |
          version="${{ needs.bump_version.outputs.new_version }}"
          backend="ghcr.io/${GITHUB_REPOSITORY_OWNER}/in-the-event-of-my-death-backend:v${version}"
          web="ghcr.io/${GITHUB_REPOSITORY_OWNER}/in-the-event-of-my-death-web:v${version}"
          ssh -o BatchMode=yes -o ConnectTimeout=10 "${{ secrets.PROD_SSH_USER }}@${{ secrets.PROD_SSH_HOST }}" \
            "INTERNAL_API_KEY='${{ secrets.INTERNAL_API_KEY }}' sudo -E /usr/local/bin/ieomd-deploy deploy --dir /opt/ieomd --backend-image ${backend} --web-image ${web}"

      - uses: actions/checkout@v4

      - name: Smoke test
        run: |
          python3 scripts/smoke-test.py "https://${{ secrets.PROD_SITE_HOST }}" --health-only
          echo "## Production Deployment" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Version:** v${{ needs.bump_version.outputs.new_version }}" >> "$GITHUB_STEP_SUMMARY"
          echo "âœ… Production is healthy" >> "$GITHUB_STEP_SUMMARY"
