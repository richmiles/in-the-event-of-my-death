#!/usr/bin/env bash
set -euo pipefail

usage() {
  echo "Usage: ieomd-deploy deploy --dir /opt/ieomd --backend-image <ref> --web-image <ref> [--backup-dir /var/backups/ieomd]" >&2
}

if [[ "${1:-}" != "deploy" ]]; then
  usage
  exit 2
fi
shift

deploy_dir="/opt/ieomd"
backup_dir="/var/backups/ieomd"
backend_image=""
web_image=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --dir)
      deploy_dir="$2"
      shift 2
      ;;
    --backup-dir)
      backup_dir="$2"
      shift 2
      ;;
    --backend-image)
      backend_image="$2"
      shift 2
      ;;
    --web-image)
      web_image="$2"
      shift 2
      ;;
    *)
      echo "Unknown arg: $1" >&2
      usage
      exit 2
      ;;
  esac
done

if [[ -z "$backend_image" || -z "$web_image" ]]; then
  echo "Missing required --backend-image / --web-image" >&2
  usage
  exit 2
fi

timestamp="$(date -u +%Y%m%dT%H%M%SZ)"
mkdir -p "$backup_dir"

cd "$deploy_dir"

export BACKEND_IMAGE="$backend_image"
export WEB_IMAGE="$web_image"

echo "[ieomd] pulling images..."
docker compose pull

db_path="${DB_PATH:-/var/lib/ieomd/secrets.db}"
if [[ -f "$db_path" ]]; then
  backup_path="$backup_dir/secrets.db.$timestamp"
  echo "[ieomd] backing up DB to $backup_path"
  cp -a "$db_path" "$backup_path"
else
  echo "[ieomd] no existing DB at $db_path (first deploy?)"
fi

echo "[ieomd] running migrations..."
docker compose run --rm backend alembic upgrade head

echo "[ieomd] starting services..."
docker compose up -d --remove-orphans

echo "[ieomd] done"
