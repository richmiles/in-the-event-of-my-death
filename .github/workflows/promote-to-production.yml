name: Promote to Production

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        type: choice
        default: 'minor'
        options:
          - minor   # 0.1.0 -> 0.2.0 (project completion)
          - patch   # 0.1.0 -> 0.1.1 (hotfix)

permissions:
  contents: write
  actions: read
  pull-requests: write

jobs:
  get_staging_tag:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.get_tag.outputs.tag }}
      commit_sha: ${{ steps.get_tag.outputs.commit_sha }}
      commit_message: ${{ steps.get_tag.outputs.commit_message }}
    steps:
      - name: Get latest staging deployment tag
        id: get_tag
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Find the latest successful staging deployment
          run_info=$(gh api \
            "/repos/${{ github.repository }}/actions/workflows/build-and-deploy-staging.yml/runs?status=success&per_page=1" \
            --jq '.workflow_runs[0] | {head_sha, display_title}')

          if [ -z "$run_info" ] || [ "$run_info" = "null" ]; then
            echo "::error::No successful staging deployments found"
            exit 1
          fi

          commit_sha=$(echo "$run_info" | jq -r '.head_sha')
          commit_message=$(echo "$run_info" | jq -r '.display_title')
          short_sha="${commit_sha::7}"
          tag="sha-${short_sha}"

          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "commit_sha=$commit_sha" >> "$GITHUB_OUTPUT"
          echo "commit_message=$commit_message" >> "$GITHUB_OUTPUT"

          echo "## Staging Version" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Tag:** \`$tag\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Commit:** \`$commit_sha\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Message:** $commit_message" >> "$GITHUB_STEP_SUMMARY"

  bump_version:
    runs-on: ubuntu-latest
    needs: get_staging_tag
    outputs:
      new_version: ${{ steps.bump.outputs.new_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'current'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump version
        id: bump
        working-directory: frontend
        run: |
          # Bump version (npm version updates package.json and creates a commit)
          new_version=$(npm version ${{ inputs.version_bump }} --no-git-tag-version)
          # Remove the 'v' prefix that npm adds
          new_version="${new_version#v}"
          echo "new_version=$new_version" >> "$GITHUB_OUTPUT"
          echo "Bumped to version: $new_version"

      - name: Create branch and PR
        id: create_pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          version="${{ steps.bump.outputs.new_version }}"
          branch="chore/bump-version-v${version}"

          # Create and push branch
          git checkout -b "$branch"
          git add frontend/package.json
          git commit -m "chore: bump version to v${version}"
          git push origin "$branch"

          # Create PR and merge it
          pr_url=$(gh pr create \
            --title "chore: bump version to v${version}" \
            --body "Automated version bump for release v${version}" \
            --base main \
            --head "$branch")

          echo "Created PR: $pr_url"

          # Wait for checks then merge
          gh pr merge "$pr_url" --auto --squash --delete-branch

          echo "## Version Bump" >> "$GITHUB_STEP_SUMMARY"
          echo "- **New version:** v${version}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Bump type:** ${{ inputs.version_bump }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **PR:** $pr_url" >> "$GITHUB_STEP_SUMMARY"

      - name: Wait for PR merge and tag
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          version="${{ steps.bump.outputs.new_version }}"
          branch="chore/bump-version-v${version}"

          # Wait for the PR to be merged (auto-merge enabled above)
          echo "Waiting for PR to be merged..."
          for i in {1..60}; do
            state=$(gh pr view "$branch" --json state --jq '.state')
            if [ "$state" = "MERGED" ]; then
              echo "PR merged successfully"
              break
            fi
            if [ "$state" = "CLOSED" ]; then
              echo "::error::PR was closed without merging"
              exit 1
            fi
            echo "PR state: $state, waiting... ($i/60)"
            sleep 10
          done

          if [ "$state" != "MERGED" ]; then
            echo "::error::Timed out waiting for PR to merge"
            exit 1
          fi

          # Fetch the merged main and create tag
          git fetch origin main
          git checkout origin/main
          git tag "v${version}"
          git push origin "v${version}"

          echo "- **Tag:** v${version} created" >> "$GITHUB_STEP_SUMMARY"

  deploy_production:
    runs-on: ubuntu-latest
    needs: [get_staging_tag, bump_version]
    environment: production
    steps:
      - name: Display deployment info
        run: |
          echo "## Production Deployment" >> "$GITHUB_STEP_SUMMARY"
          echo "Deploying **${{ needs.get_staging_tag.outputs.tag }}** to production" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Version:** v${{ needs.bump_version.outputs.new_version }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Commit:** \`${{ needs.get_staging_tag.outputs.commit_sha }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Message:** ${{ needs.get_staging_tag.outputs.commit_message }}" >> "$GITHUB_STEP_SUMMARY"

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PROD_SSH_KEY }}

      - name: Configure known_hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.PROD_SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy (remote)
        run: |
          tag="${{ needs.get_staging_tag.outputs.tag }}"
          backend="ghcr.io/${GITHUB_REPOSITORY_OWNER}/in-the-event-of-my-death-backend:${tag}"
          web="ghcr.io/${GITHUB_REPOSITORY_OWNER}/in-the-event-of-my-death-web:${tag}"
          ssh -o BatchMode=yes -o ConnectTimeout=10 "${{ secrets.PROD_SSH_USER }}@${{ secrets.PROD_SSH_HOST }}" \
            "sudo /usr/local/bin/ieomd-deploy deploy --dir /opt/ieomd --backend-image ${backend} --web-image ${web}"

      - uses: actions/checkout@v4

      - name: Smoke test
        run: |
          python3 scripts/smoke-test.py "https://${{ secrets.PROD_SITE_HOST }}" --health-only
          echo "âœ… Production is healthy" >> "$GITHUB_STEP_SUMMARY"
