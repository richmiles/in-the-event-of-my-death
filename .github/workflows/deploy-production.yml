name: Deploy (Production)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Image tag to deploy (e.g. sha-abcdef0 or v0.1.0-beta)"
        required: true

permissions:
  contents: read

jobs:
  deploy_production:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PROD_SSH_KEY }}

      - name: Configure known_hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.PROD_SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts

      - name: Deploy (remote)
        run: |
          backend="ghcr.io/${GITHUB_REPOSITORY_OWNER}/in-the-event-of-my-death-backend:${{ inputs.tag }}"
          web="ghcr.io/${GITHUB_REPOSITORY_OWNER}/in-the-event-of-my-death-web:${{ inputs.tag }}"
          ssh "${{ secrets.PROD_SSH_USER }}@${{ secrets.PROD_SSH_HOST }}" \
            "sudo /usr/local/bin/ieomd-deploy deploy --dir /opt/ieomd --backend-image ${backend} --web-image ${web}"

      - name: Smoke test
        run: |
          for i in $(seq 1 30); do
            if curl -fsS "https://${{ secrets.PROD_SITE_HOST }}/health" | jq -e '.status == "healthy"' > /dev/null; then
              exit 0
            fi
            sleep 2
          done
          echo "Smoke test failed: /health never became healthy" >&2
          exit 1
